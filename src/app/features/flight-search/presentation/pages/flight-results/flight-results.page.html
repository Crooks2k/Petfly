<app-header></app-header>
<p-toast position="top-right" [breakpoints]="{ '920px': { width: '90%' } }"></p-toast>

<div class="flight-results-page">
  <div class="results-container">
    <aside class="filters-aside" [class.collapsed]="isFiltersAsideCollapsed">
      <button
        type="button"
        class="collapse-toggle-btn"
        (click)="toggleFiltersAside()"
        [attr.aria-label]="
          isFiltersAsideCollapsed ? texts.expandFiltersLabel : texts.collapseFiltersLabel
        "
        [title]="isFiltersAsideCollapsed ? texts.expandFiltersLabel : texts.collapseFiltersLabel"
      >
        <i
          class="pi"
          [class.pi-angle-right]="isFiltersAsideCollapsed"
          [class.pi-angle-left]="!isFiltersAsideCollapsed"
        ></i>
      </button>

      <div class="collapsed-icon" *ngIf="isFiltersAsideCollapsed">
        <i class="pi pi-filter"></i>
        <span class="collapsed-text">{{ texts.filtersCollapsedLabel }}</span>
      </div>

      <div class="filters-content" [hidden]="isFiltersAsideCollapsed">
        <app-filters-aside
          [filtersForm]="filtersForm"
          [selectedPetType]="selectedPetType"
          [today]="today"
          [filtersBoundary]="searchResults?.filtersBoundary || null"
          (petTypeSelected)="selectPetType($event)"
          (certificateToggled)="toggleCertificate($event)"
          (filtersApplied)="onFiltersApplied()"
        >
        </app-filters-aside>
      </div>
      <div class="filters-aside-footer" [hidden]="isFiltersAsideCollapsed">
        <button
          type="button"
          class="filter-button-desktop"
          (click)="onFiltersApplied()"
          [disabled]="viewModel.isLoadingResults"
        >
          <i class="pi pi-spin pi-spinner" *ngIf="viewModel.isLoadingResults"></i>
          <span *ngIf="!viewModel.isLoadingResults">{{ texts.applyFiltersLabel }}</span>
          <span *ngIf="viewModel.isLoadingResults">{{ texts.applyingFilters }}</span>
        </button>
      </div>
    </aside>

    <main class="results-content">
      <div class="pet-price-info" [class.collapsed]="!isPetPriceInfoOpen">
        <div class="info-header" (click)="togglePetPriceInfo()">
          <div class="info-title-wrapper">
            <i class="pi pi-info-circle"></i>
            <h3 class="info-title-text">{{ texts.petPriceInfoTitle }}</h3>
          </div>
          <i class="pi pi-chevron-down chevron-icon" [class.rotated]="isPetPriceInfoOpen"></i>
        </div>

        <div class="price-options">
          <details class="price-option">
            <summary class="option-header">
              <div class="option-left">
                <span class="option-badge badge-blue">{{ texts.regularPetBadge }}</span>
                <div class="option-text">
                  <span class="option-title">{{ texts.regularPetTitle }}</span>
                </div>
              </div>
              <i class="pi pi-chevron-down"></i>
            </summary>
            <div class="option-content">
              <p class="option-description">{{ texts.regularPetDescription }}</p>
            </div>
          </details>

          <details class="price-option">
            <summary class="option-header">
              <div class="option-left">
                <span class="option-badge badge-orange">{{ texts.emotionalSupportBadge }}</span>
                <div class="option-text">
                  <span class="option-title">{{ texts.emotionalSupportTitle }}</span>
                </div>
              </div>
              <i class="pi pi-chevron-down"></i>
            </summary>
            <div class="option-content">
              <p class="option-description">{{ texts.emotionalSupportDescription }}</p>
              <a
                href="https://petfly.io/certificado-de-apoyo-emocional/"
                target="_blank"
                rel="noopener noreferrer"
                class="certificate-link"
              >
                <i class="pi pi-external-link"></i>
                <span>{{ texts.certificateAELinkText }}</span>
              </a>
            </div>
          </details>

          <details class="price-option">
            <summary class="option-header">
              <div class="option-left">
                <span class="option-badge badge-green">{{ texts.serviceDogBadge }}</span>
                <div class="option-text">
                  <span class="option-title">{{ texts.serviceDogTitle }}</span>
                </div>
              </div>
              <i class="pi pi-chevron-down"></i>
            </summary>
            <div class="option-content">
              <p class="option-description">{{ texts.serviceDogDescription }}</p>
              <a
                href="https://petfly.io/certificados-de-perro-de-servicio/"
                target="_blank"
                rel="noopener noreferrer"
                class="certificate-link"
              >
                <i class="pi pi-external-link"></i>
                <span>{{ texts.certificatePSLinkText }}</span>
              </a>
            </div>
          </details>
        </div>
      </div>

      <div class="search-results-container">
        <div class="results-header">
          <div class="results-info">
            <h3 class="results-title">{{ texts.searchResultsTitle }}</h3>
            <span class="results-count">
              {{ sortedFlightTickets.length || 0 }} {{ texts.flightsFound }}
            </span>
          </div>
          <div class="sort-container">
            <button
              class="sort-button"
              [class.active]="currentSort === 'price'"
              (click)="toggleSort('price')"
            >
              <i
                class="pi"
                [class.pi-sort-amount-down]="currentSort === 'price' && sortDirection === 'asc'"
                [class.pi-sort-amount-up]="currentSort === 'price' && sortDirection === 'desc'"
                [class.pi-sort-alt]="currentSort !== 'price'"
              ></i>
              <span>{{ texts.sortByPrice }}</span>
            </button>
            <button
              class="sort-button"
              [class.active]="currentSort === 'duration'"
              (click)="toggleSort('duration')"
            >
              <i class="pi pi-clock"></i>
              <span>{{ texts.sortByDuration }}</span>
            </button>
          </div>
        </div>

        <div class="results-list">
          <div *ngIf="!sortedFlightTickets || sortedFlightTickets.length === 0" class="no-results">
            <i class="pi pi-inbox"></i>
            <h3>{{ texts.noResultsTitle }}</h3>
            <p>{{ texts.noResultsMessage }}</p>
          </div>

          <ng-container
            *ngFor="let flightTicket of displayedFlightTickets; trackBy: trackByFlightTicket"
          >
            <petfly-flight-card-mobile
              class="mobile-only"
              [flightTicket]="flightTicket"
              [isRoundTrip]="isRoundTrip"
              [displayCurrency]="searchCurrency"
            >
            </petfly-flight-card-mobile>

            <petfly-flight-card-desktop
              class="desktop-only"
              [flightTicket]="flightTicket"
              [isRoundTrip]="isRoundTrip"
              [displayCurrency]="searchCurrency"
            >
            </petfly-flight-card-desktop>
          </ng-container>

          <div *ngIf="hasMoreFlights" class="load-more-container">
            <button class="load-more-button" (click)="loadMoreFlights()">
              <span
                >{{ texts.loadMoreFlightsLabel }} ({{
                  sortedFlightTickets.length - currentDisplayCount
                }}
                {{ texts.remainingLabel }})</span
              >
              <i class="pi pi-chevron-down"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <button class="mobile-filter-button" (click)="openFiltersModal()">
    <i class="pi pi-filter"></i>
    <span>{{ texts.filtersLabel }}</span>
  </button>

  <div class="filters-modal" [class.active]="isFiltersModalOpen">
    <div class="modal-overlay" (click)="closeFiltersModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ texts.filtersLabel }}</h2>
        <button class="close-button" (click)="closeFiltersModal()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="filters-content">
          <app-filters-aside
            [filtersForm]="filtersForm"
            [selectedPetType]="selectedPetType"
            [today]="today"
            [filtersBoundary]="searchResults?.filtersBoundary || null"
            (petTypeSelected)="selectPetType($event)"
            (certificateToggled)="toggleCertificate($event)"
            (filtersApplied)="applyFilters()"
          >
          </app-filters-aside>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="apply-filters-button"
          (click)="applyFilters()"
          [disabled]="viewModel.isLoadingResults"
        >
          <i class="pi pi-spin pi-spinner" *ngIf="viewModel.isLoadingResults"></i>
          <span *ngIf="!viewModel.isLoadingResults">{{ texts.applyFiltersLabel }}</span>
          <span *ngIf="viewModel.isLoadingResults">{{ texts.applyingFilters }}</span>
        </button>
      </div>
    </div>
  </div>
</div>
