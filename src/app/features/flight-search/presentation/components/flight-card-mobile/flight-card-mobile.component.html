<div class="flight-card" [class.expanded]="isExpanded">
  <button
    *ngIf="airlineComment"
    type="button"
    class="airline-comment-icon"
    (click)="commentOverlay.toggle($event); $event.stopPropagation()"
    aria-label="Información de la aerolínea"
  >
    <i class="pi pi-info-circle"></i>
  </button>
  <p-overlayPanel #commentOverlay [appendTo]="'body'" styleClass="airline-comment-overlay">
    <div class="airline-comment-content">{{ airlineComment }}</div>
  </p-overlayPanel>

  <div class="flight-card-header">
    <div class="flights-summary">
      <div class="flight-row">
        <img
          [src]="outboundFlight.flightItems[0].imageUrl"
          [alt]="outboundFlight.flightItems[0].airlineName"
          class="airline-logo"
        />

        <div class="flight-info">
          <div class="flight-times-row">
            <div class="time-block">
              <span class="time">{{
                formatTime(outboundFlight.flightItems[0].departureTime)
              }}</span>
              <span class="airport">{{ outboundFlight.flightItems[0].departure }}</span>
            </div>

            <div class="duration-block">
              <span class="duration">{{ formatDuration(getTotalDuration(outboundFlight)) }}</span>
              <span class="stops-info">{{ getStopsText() }}</span>
            </div>

            <div class="time-block">
              <span class="time">
                {{
                  formatTime(
                    outboundFlight.flightItems[outboundFlight.flightItems.length - 1].arrivalTime
                  )
                }}
                <span
                  class="day-offset"
                  *ngIf="
                    getArrivalDayOffset(
                      outboundFlight.flightItems[0].departureTime,
                      outboundFlight.flightItems[outboundFlight.flightItems.length - 1].arrivalTime
                    )
                  "
                >
                  {{
                    getArrivalDayOffset(
                      outboundFlight.flightItems[0].departureTime,
                      outboundFlight.flightItems[outboundFlight.flightItems.length - 1].arrivalTime
                    )
                  }}
                </span>
              </span>
              <span class="airport">{{
                outboundFlight.flightItems[outboundFlight.flightItems.length - 1].arrival
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flight-row" *ngIf="returnFlight">
        <img
          [src]="returnFlight.flightItems[0].imageUrl"
          [alt]="returnFlight.flightItems[0].airlineName"
          class="airline-logo"
        />

        <div class="flight-info">
          <div class="flight-times-row">
            <div class="time-block">
              <span class="time">{{ formatTime(returnFlight.flightItems[0].departureTime) }}</span>
              <span class="airport">{{ returnFlight.flightItems[0].departure }}</span>
            </div>

            <div class="duration-block">
              <span class="duration">{{ formatDuration(getTotalDuration(returnFlight)) }}</span>
              <span class="stops-info">{{ getStopsText() }}</span>
            </div>

            <div class="time-block">
              <span class="time">
                {{
                  formatTime(
                    returnFlight.flightItems[returnFlight.flightItems.length - 1].arrivalTime
                  )
                }}
                <span
                  class="day-offset"
                  *ngIf="
                    getArrivalDayOffset(
                      returnFlight.flightItems[0].departureTime,
                      returnFlight.flightItems[returnFlight.flightItems.length - 1].arrivalTime
                    )
                  "
                >
                  {{
                    getArrivalDayOffset(
                      returnFlight.flightItems[0].departureTime,
                      returnFlight.flightItems[returnFlight.flightItems.length - 1].arrivalTime
                    )
                  }}
                </span>
              </span>
              <span class="airport">{{
                returnFlight.flightItems[returnFlight.flightItems.length - 1].arrival
              }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="price-section">
      <div class="price-info">
        <span class="price-label">{{ texts.pricePerPerson }}</span>
        <span class="price-value">{{ formatPrice(flightTicket.price) }}</span>
      </div>
    </div>

    <button
      class="select-button-compact"
      (click)="onSelectFlight($event)"
      [disabled]="isLoadingBooking"
    >
      <i class="pi pi-spin pi-spinner" *ngIf="isLoadingBooking"></i>
      <span *ngIf="!isLoadingBooking">{{ texts.selectButton }}</span>
      <span *ngIf="isLoadingBooking">{{ texts.loading }}</span>
    </button>

    <div class="expand-icon" (click)="toggleExpanded()">
      <i class="pi" [class.pi-chevron-down]="!isExpanded" [class.pi-chevron-up]="isExpanded"></i>
      <span class="expand-text">{{ isExpanded ? texts.viewLess : texts.viewDetails }}</span>
    </div>
  </div>

  <div class="flight-card-body" *ngIf="isExpanded">
    <div class="detail-section">
      <div class="section-header">
        <i class="pi pi-tag"></i>
        <span class="section-title">{{ texts.petPrice }}</span>
      </div>
      <div class="price-display-large">
        <span *ngIf="hasTotalPetPrice"
          >{{ formatPrice(getPetPriceMin()) }}-{{ formatPrice(getPetPriceMax()) }}</span
        >
        <span *ngIf="!hasTotalPetPrice">{{ texts.notAvailable }}</span>
      </div>

      <div class="badges-section" *ngIf="hasPSPrice || hasAEPrice || hasMRPrice">
        <div class="badges-label">{{ texts.certificatesAccepted }}</div>
        <div class="badges">
          <span *ngIf="hasMRPrice" class="badge badge-mr">{{ texts.mrBadge }}</span>
          <a
            *ngIf="hasAEPrice"
            href="https://petfly.io/certificado-de-apoyo-emocional/"
            target="_blank"
            rel="noopener noreferrer"
            class="badge badge-ae"
            (click)="$event.stopPropagation()"
          >
            {{ texts.aeBadge }}
          </a>
          <a
            *ngIf="hasPSPrice"
            href="https://petfly.io/certificados-de-perro-de-servicio/"
            target="_blank"
            rel="noopener noreferrer"
            class="badge badge-ps"
            (click)="$event.stopPropagation()"
          >
            {{ texts.psBadge }}
          </a>
        </div>
        <div class="badge-hint">
          <i class="pi pi-info-circle"></i>
          <span>{{ texts.clickCertificatesInfo }}</span>
        </div>
      </div>

      <div class="certificate-status" *ngIf="isAENotAccepted || isPSNotAccepted || isMRNotAccepted">
        <div class="status-title">{{ texts.certificatesNotAccepted }}</div>
        <div class="ae-status" *ngIf="isAENotAccepted">{{ texts.aeNotAccepted }}</div>
        <div class="ae-status" *ngIf="isPSNotAccepted">{{ texts.psNotAccepted }}</div>
        <div class="ae-status" *ngIf="isMRNotAccepted">{{ texts.mrNotAccepted }}</div>
      </div>
    </div>

    <div class="detail-section total-section">
      <div class="section-header">
        <i class="pi pi-calculator"></i>
        <span class="section-title">{{ texts.totalPrice }}</span>
      </div>
      <div class="total-subtitle">{{ texts.totalPriceSubtitle }}</div>
      <div class="price-display-large total">
        <ng-container *ngIf="flightTicket.total; else naTotal">
          {{ formatPrice(flightTicket.total.min) }}-{{ formatPrice(flightTicket.total.max) }}
        </ng-container>
        <ng-template #naTotal>N/A</ng-template>
      </div>
    </div>

    <div class="price-warning">
      <i class="pi pi-exclamation-triangle"></i>
      <span>{{ texts.priceEstimationWarning }}</span>
    </div>
  </div>
</div>
